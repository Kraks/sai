#!/bin/bash
# Usage: test_benchmark.sh <benchmark.ll>
# Effect: will use RunLLSC to compile and run make subsequently in the llsc_gen folder, finally execute the executable.
# Requires: bloop cli (https://scalacenter.github.io/bloop/docs/cli/tutorial)

# /some/path/to/xyz.ll
LL=$1
shift
OPT="$@"
echo -n "[test_benchmark] "
date
echo -e "[test_benchmark] input:\t\t$LL"
echo -e "[test_benchmark] options:\t$OPT"

# Xyz
HEAD=$LL
HEAD=${HEAD##*/}
HEAD=${HEAD%.ll}
HEAD=${HEAD^}

export SBT_OPTS="-Xms4G -Xmx32G -Xss1024M -XX:MaxMetaspaceSize=8G -XX:ReservedCodeCacheSize=2048M"
/usr/bin/time --format "[test_benchmark] scala compilation time => real: %E,\tuser: %U,\tsys: %S" \
	sbt "runMain sai.llsc.RunLLSC ${LL} ${HEAD} @main 0"
{ cd llsc_gen/${HEAD};
	# make clean;
	/usr/bin/time --format "[test_benchmark] c++ compilation time => real: %E,\tuser: %U,\tsys: %S" \
		make -j4; 
} && timeout 300 ./${HEAD} "${OPT}";
