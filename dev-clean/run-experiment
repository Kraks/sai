#!/usr/bin/env bash

# set up PATH, CPLUS_INCLUDE_PATH, LD_LIBRARY_PATH, LIBRARY_PATH
source ~/sai_install/env.sh

ICSE23DIR=/u/antor/u12/deng254/sai_install/coreutils/icse23_linked

branches=(
meta-fs-coreutils
)

candidates=(
comm
echo
dirname
base32
base64
cat
cut
expand
false
fold
join
link
paste
pathchk
true
)

declare -A options=(
[base32]='--argv="name A" --sym-file-size={0..30..10} --add-sym-file A' # path=1?
[base64]='--argv="name A" --add-sym-file A'
[comm]='--argv="name A B" --sym-file-size={1..3} --add-sym-file=A --add-sym-file=B'
[cut]='--argv="name #3" --add-sym-file A'
[cat]='--argv="name A" --sym-file-size={0..30..10} --add-sym-file A'
[dirname]='--argv="name some/#{5..10}/dir"'
[echo]='--argv="name #{1..10}"'
[expand]='--argv="name #3" --add-sym-file A'
[false]='--argv="name #3" --add-sym-file A'
[fold]='--argv="name #3" --add-sym-file A'
[join]='--argv="name #3" --add-sym-file A'
[link]='--argv="name #3" --add-sym-file A'
[paste]='--argv="name #3" --add-sym-file A'
[pathchk]='--argv="name #3" --add-sym-file A'
[true]='--argv="name {'\''--sym-arg 11'\'', #10}"' # klee and llsc, klee path=1
)

for branch in ${branches[@]}; do
	# preprocess output
	rm -f full.log
	exec >  >(tee -ia full.log)
	exec 2> >(tee -ia full.log >&2)
	echo [run-experiment] branch: $branch
	git checkout ${branch}
	if [ $? -ne 0 ]; then echo "[run-experiment] Failed to switch to branch ${branch}, skipping."; continue; fi
	COMMIT_HASH=hash_$(git rev-parse --short HEAD)
	echo [run-experiment] hash: $COMMIT_HASH
	for f in ${candidates[@]}; do
		option=`printf "%q" "${options[$f]}"` # extract the options with quotes
		./test_benchmark --no-scala --no-cpp --njobs 100 --timeout 500 -- $ICSE23DIR/$f.ll ${COMMIT_HASH}_icse23_${f} $option
	done
	grep '[run_runtime]' full.log > ${COMMIT_HASH}_icse23_runtime.log
done

